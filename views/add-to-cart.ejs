<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seleccionar Cantidad</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&display=swap" rel="stylesheet">
    <style> .font-oswald { font-family: 'Oswald', sans-serif; } </style>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>
<body class="bg-black text-white font-oswald">

    <%- include('partials/header') %>

    <main class="py-16 px-8">
        <div class="max-w-lg mx-auto bg-[#1a1a1a] rounded-xl p-8 border-2 border-[#FFC72C]">
            <h1 class="text-3xl uppercase text-[#FFC72C] mb-6 text-center">Añadir al Carrito</h1>
            
            <div class="text-center mb-6">
                <img src="<%= product.foto %>" alt="Foto de <%= product.nombre_producto %>" class="w-48 h-48 object-cover mx-auto rounded-lg mb-4">
                <h2 class="text-2xl text-white"><%= product.nombre_producto %></h2>
                <p class="text-lg text-[#FFC72C] font-bold">$<%= product.precio.toFixed(2) %></p>
            </div>

            <form id="add-to-cart-form">
                <div class="mb-6">
                    <label for="quantity" class="block text-lg text-white mb-2">Cantidad:</label>
                    <input type="number" id="quantity" name="quantity" value="1" min="1" class="w-full bg-gray-800 text-white rounded-md p-3 border-2 border-gray-600 focus:border-[#FFC72C] focus:outline-none">
                </div>
                
                <input type="hidden" id="productId" name="productId" value="<%= product.id_producto %>">
                
                <button type="submit" class="w-full bg-[#DA291C] text-white py-3 rounded-full font-bold hover:bg-[#a81f13]">Agregar al Carrito</button>
            </form>
        </div>
    </main>

    <%- include('partials/footer') %>

    <script>
        document.getElementById('add-to-cart-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const productId = document.getElementById('productId').value;
            const quantity = document.getElementById('quantity').value;
            const token = getToken();

            if (!token) {
                alert('Por favor inicia sesión para agregar productos al carrito');
                window.location.href = '/acceder';
                return;
            }

            try {
                const cartResponse = await fetch('/carts/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!cartResponse.ok) {
                    if (cartResponse.status === 401) {
                        alert('Tu sesión expiró. Por favor inicia sesión de nuevo.');
                        window.location.href = '/acceder';
                        return;
                    }
                    alert('Error al obtener el carrito');
                    return;
                }

                const carts = await cartResponse.json();
                const cart = carts[0];

                const addResponse = await fetch(`/carts/${cart.id_carrito}/add`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id_producto: parseInt(productId),
                        cantidad: parseInt(quantity)
                    })
                });

                if (addResponse.ok) {
                    alert('✅ Producto agregado al carrito');
                    window.location.href = '/'; // Redirigir al inicio
                } else {
                    alert('Error al agregar al carrito');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al agregar al carrito');
            }
        });

        function getToken() {
            let t = localStorage.getItem('token') || '';
            if (!t) {
                const cookiePair = (document.cookie.split(';').find(c => c.trim().startsWith('Authorization=')) || '');
                t = cookiePair ? cookiePair.split('=')[1] : '';
            }
            if (!t) return null;
            if (t.startsWith('Bearer ')) t = t.replace('Bearer ', '');
            return t;
        }
    </script>

</body>
</html>
